<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Job Manager - <%= company.name %></title>
  <link rel="stylesheet" href="/css/index.css">
  <link rel="stylesheet" href="/css/job.css">
</head>

<body style="
  background: <%= company ? 'linear-gradient(135deg, ' + company.pColor + ', ' + company.sColor + ')' : 'transparent' %>;
  color: <%= company.bpColor %>;
  --pColor: <%= company.pColor %>;
  --sColor: <%= company.sColor %>;
  --bpColor: <%= company.bpColor %>;
  --bsColor: <%= company.bsColor %>;
">
  <main class="jobs-container">
    <div class="nav-row">
      <button class="small-btn" onclick="location.href='/companies'">All companies</button>
      <button class="small-btn" onclick="location.href='/'">Home</button>
      <button class="small-btn" onclick="location.href='/job/<%= encodeURIComponent(company.name) %>'">Job Page</button>
      <button class="small-btn" onclick="location.href='/jobPosts/<%= encodeURIComponent(company.name) %>'">Post a Job</button>
    </div>

    <div class="jobs-header">
      <h1>Manage Jobs: <%= company ? company.name : 'Not found' %></h1>
    </div>

    <div class="jobs-columns">
      <!-- Available Jobs Column -->
      <section class="jobs-column">
        <h2>Available</h2>
        <div class="jobs-scroll">
          <% if (jobs && jobs.length > 0) { %>
            <% jobs.filter(job => !job.employee_id && !job.has_applications).forEach(function(job){ %>
              <article class="job-card">
                <div class="job-title"><b><%= job.title %></b></div>
                <div class="job-desc"><%= job.description %></div>
                <div class="job-pay">Pay: <%= job.pay %></div>
                <div class="job-meta available">Available</div>
              </article>
            <% }) %>
          <% } else { %>
            <p>No available jobs</p>
          <% } %>
        </div>
      </section>

      <!-- Applied For Column -->
      <section class="jobs-column">
        <h2>Applied For</h2>
        <div class="jobs-scroll">
          <% if (jobs && jobs.length > 0) { %>
            <% jobs.filter(job => job.has_applications && !job.employee_id).forEach(function(job){ %>
              <article class="job-card">
                <div class="job-title"><b><%= job.title %></b></div>
                <div class="job-desc"><%= job.description %></div>
                <div class="job-pay">Pay: <%= job.pay %></div>
                <div class="job-meta taken">
                  <%= job.applicants_count %> applicant(s)
                  <% if (job.applicants && job.applicants.length > 0) { %>
                    <ul>
                      <% job.applicants.forEach(applicant => { %>
                        <li>
                          <%= applicant.name %>
                          <form action="/jobManager/accept" method="POST" style="display:inline;" onsubmit="return confirm('Accept this applicant for the job?');">
                            <input type="hidden" name="jobId" value="<%= job.id %>">
                            <input type="hidden" name="applicantId" value="<%= applicant.fb_id %>">
                            <button type="submit" class="accept">Accept</button>
                          </form>
                        </li>
                      <% }) %>
                    </ul>
                  <% } %>
                </div>
              </article>
            <% }) %>
          <% } else { %>
            <p>No applications yet</p>
          <% } %>
        </div>
      </section>

      <!-- In Progress Column -->
      <section class="jobs-column">
        <h2>In Progress</h2>
        <div class="jobs-scroll">
          <% if (jobs && jobs.length > 0) { %>
            <% jobs.filter(job => job.employee_id && job.status !== 'completed').forEach(function(job){ %>
              <article class="job-card">
                <div class="job-title"><b><%= job.title %></b></div>
                <div class="job-desc"><%= job.description %></div>
                <div class="job-pay">Pay: <%= job.pay %></div>
                <div class="job-meta taken">
                  Assigned to <%= job.employee_name %>
                  <button class="complete-button" 
                          data-job-id="<%= job.id %>"
                          data-employee-id="<%= job.employee_id %>"
                          data-pay="<%= job.pay %>"
                          data-title="<%= job.title %>">
                    Mark As Complete
                  </button>
                </div>
              </article>
            <% }) %>
          <% } else { %>
            <p>No jobs in progress</p>
          <% } %>
        </div>
      </section>

      <!-- Completed Jobs Column -->
      <section class="jobs-column">
        <h2>Completed</h2>
        <div class="jobs-scroll">
          <% if (jobs && jobs.length > 0) { %>
            <% jobs.filter(job => job.status === 'completed').forEach(function(job){ %>
              <article class="job-card">
                <div class="job-title"><b><%= job.title %></b></div>
                <div class="job-desc"><%= job.description %></div>
                <div class="job-pay">Pay: <%= job.pay %></div>
                <div class="job-meta completed">Completed by <%= job.employee_name %></div>
              </article>
            <% }) %>
          <% } else { %>
            <p>No completed jobs</p>
          <% } %>
        </div>
      </section>
    </div>
  </main>

  <!-- PIN Popup for Mark As Complete -->
  <div id="custom-popup" class="popup-overlay">
    <div class="popup-content">
      <button class="close-btn">&times;</button>
      <h2>Enter PIN to Complete Job</h2>
      <form id="popup-form">
        <input type="password" id="pin" name="pin" placeholder="Enter your PIN" required>
        <button type="submit">Confirm</button>
      </form>
    </div>
  </div>

  <script>
    // Only handle the PIN popup for Mark As Complete
    document.addEventListener('DOMContentLoaded', function () {
      const popup = document.getElementById('custom-popup');
      const closeBtn = popup.querySelector('.close-btn');
      const popupForm = document.getElementById('popup-form');
      
      let currentJobId = null;
      let currentEmployeeId = null;
      let currentPay = null;
      let currentTitle = null;

      // Handle "Mark As Complete" button clicks
      document.querySelectorAll('.complete-button').forEach(button => {
        button.addEventListener('click', function () {
          currentJobId = this.getAttribute('data-job-id');
          currentEmployeeId = this.getAttribute('data-employee-id');
          currentPay = this.getAttribute('data-pay');
          currentTitle = this.getAttribute('data-title');
          popup.style.display = 'flex';
        });
      });

      // Close popup
      closeBtn.addEventListener('click', function () {
        popup.style.display = 'none';
        popupForm.reset();
      });

      popup.addEventListener('click', function (e) {
        if (e.target === popup) {
          popup.style.display = 'none';
          popupForm.reset();
        }
      });

      // Handle form submission
      popupForm.addEventListener('submit', async function (e) {
        e.preventDefault();
        const pin = document.getElementById('pin').value;

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/jobManager/complete';

        const fields = {
          jobId: currentJobId,
          employeeId: currentEmployeeId,
          pay: currentPay,
          title: currentTitle,
          pin: pin
        };

        for (const [key, value] of Object.entries(fields)) {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = key;
          input.value = value;
          form.appendChild(input);
        }

        document.body.appendChild(form);
        form.submit();
      });
    });
  </script>
</body>

</html>