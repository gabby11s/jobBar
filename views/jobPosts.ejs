<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Post</title>
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/post.css">
</head>
<body
  style="
  background: <%= company ? 'linear-gradient(180deg, ' + company.pColor + ', ' + company.sColor + ')' : 'transparent' %>;
  color: <%= company.bpColor %>;
  --pColor: <%= company.pColor %>;
  --sColor: <%= company.sColor %>;
  --bpColor: <%= company.bpColor %>;
  --bsColor: <%= company.bsColor %>;
  " class="post-job-page">
    <nav class="top-controls">
        <button onclick="location.href='/'" style="border: 1px solid <%= company.bsColor %>;">Home</button>
        <button onclick="location.href='/job/<%= encodeURIComponent(company.name) %>'" style="border: 1px solid <%= company.bsColor %>;">Job Page</button>
        <button onclick="location.href='/companies'" style="border: 1px solid <%= company.bsColor %>;">Companies</button>
    </nav>

    <div class="container">
      <div class="post-card">
        <h1>Post a Job for <%= company %></h1>
        <form id="jobpost-form" action="/jobPosts" method="POST">
            <input type="hidden" name="company" value="<%= company %>">
            <div class="form-row">
                <label for="title">Job Title:</label>
                <input type="text" id="title" name="title" maxlength="100" required>
            </div>
            <div class="form-row">
                <label for="description">Description:</label>
                <textarea id="description" name="description" maxlength="200" required></textarea>
            </div>
            <div class="form-row">
                <label for="pay">Pay:</label>
                <input type="number" id="pay" name="pay" required>
            </div>
            <input type="hidden" name="status" value="available">
            <button type="submit" style="background-color: <%= company.pColor %>; color: <%= company.bpColor %>; border: 1px solid <%= company.bpColor %>;">Submit</button>
        </form>
        <script>
            (function(){
                const form = document.getElementById('jobpost-form');
                if (!form) return;
                let bypass = false;
                form.addEventListener('submit', async function(e){
                    if (bypass) return;
                    e.preventDefault();
                    const fd = new FormData(form);
                    const payload = {
                        company: fd.get('company'),
                        title: fd.get('title'),
                        description: fd.get('description'),
                        pay: fd.get('pay'),
                        pin: fd.get('pin') || ''
                    };
                    try {
                        const res = await fetch('/transfer/job', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'same-origin',
                            body: JSON.stringify(payload)
                        });
                        const data = await res.json().catch(()=>({}));
                        if (res.ok && data && data.success) {
                            bypass = true;
                            form.submit();
                        } else {
                            alert('Payment failed: ' + (data && data.message ? data.message : 'unknown'));
                        }
                    } catch(err) {
                        console.error('Payment error', err);
                        alert('Payment failed');
                    }
                });
            })();
        </script>
      </div>
    </div>

</body>
</html>